jobs:
- job: Linux
  dependsOn: GetReleaseVersion
  timeoutInMinutes: 180

  variables:
    ReleaseVersion: $[ dependencies.GetReleaseVersion.outputs['Version.ReleaseVersion'] ]
  pool:
    # This image is used to host the Docker container that runs the build
    vmImage: ubuntu-16.04

  container: atom-linux-ci

  steps:
  - script: |
      if [ $IS_RELEASE_BRANCH == "true" ] || [ $IS_SIGNED_ZIP_BRANCH == "true" ]; then
        script/build --create-debian-package --create-rpm-package --compress-artifacts
      else
        script/build --compress-artifacts
      fi
    env:
      IS_RELEASE_BRANCH: $(IsReleaseBranch)
      IS_SIGNED_ZIP_BRANCH: $(IsSignedZipBranch)
      ATOM_RELEASE_VERSION: $(ReleaseVersion)
    displayName: Build Atom

  - script: script/lint
    displayName: Run linter

  - script: |
      script/test
      ls -al $(Common.TestResultsDirectory)/**/TEST-*.xml
    env:
      CI: true
      CI_PROVIDER: VSTS
      TEST_JUNIT_XML_ROOT: $(Common.TestResultsDirectory)
    displayName: Run tests
    condition: and(succeeded(), ne(variables['Atom.SkipTests'], 'true'))

  - task: PublishTestResults@2
    inputs:
      testRunTitle: Linux
      testResultsFormat: JUnit
      testResultsFiles: $(Common.TestResultsDirectory)/**/TEST-*.xml
      mergeTestResults: true
    displayName: Publish test results
    condition: ne(variables['Atom.SkipTests'], 'true')

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: $(Build.SourcesDirectory)/out/atom.x86_64.rpm
      ArtifactName: atom.x86_64.rpm
      ArtifactType: Container
    displayName: Upload atom.x84_64.rpm
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: $(Build.SourcesDirectory)/out/atom-amd64.deb
      ArtifactName: atom-amd64.deb
      ArtifactType: Container
    displayName: Upload atom-amd64.deb
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: $(Build.SourcesDirectory)/out/atom-amd64.tar.gz
      ArtifactName: atom-amd64.tar.gz
      ArtifactType: Container
    displayName: Upload atom-amd64.tar.gz
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
